import threading
import requests
import time
import random
from concurrent.futures import ThreadPoolExecutor
from requests.adapters import HTTPAdapter
import warnings
import validators

print("************æœ¬è½¯ä»¶ä»…ç”¨äºWebæœåŠ¡å™¨æ€§èƒ½æµ‹è¯•ï¼*************\n",
      "****æµ‹è¯•æ•ˆæœä¸å½“åœ°OLTã€è·¯ç”±å™¨ã€å…‰çŒ«ä»¥åŠç”µè„‘æœ¬èº«æ€§èƒ½æœ‰å…³ï¼****")

# ===== é…ç½®å‚æ•° =====
def get_valid_urls():
    """å¾ªç¯è·å–ç”¨æˆ·è¾“å…¥çš„URLåˆ—è¡¨ï¼Œæ”¯æŒé‡æ–°è¾“å…¥å’Œé€€å‡ºé€‰é¡¹"""
    while True:
        # è·å–ç”¨æˆ·è¾“å…¥
        urls_input = input("è¯·è¾“å…¥æµ‹è¯•URLï¼ˆå¤šä¸ªURLç”¨ç©ºæ ¼åˆ†éš”ï¼Œè¾“å…¥'exit'é€€å‡ºï¼‰: ").strip()

        # é€€å‡ºæ£€æŸ¥
        if urls_input.lower() == 'exit':
            print("å·²é€€å‡ºURLè¾“å…¥")
            return None

        # ç©ºè¾“å…¥å¤„ç†
        if not urls_input:
            print("é”™è¯¯ï¼šå¿…é¡»æä¾›è‡³å°‘ä¸€ä¸ªURLï¼")
            continue  # ç»§ç»­å¾ªç¯è¦æ±‚é‡æ–°è¾“å…¥[1,4](@ref)

        # åˆ†å‰²URL
        url_list = [url.strip() for url in urls_input.split()]
        valid_urls = []
        invalid_found = False

        # éªŒè¯æ¯ä¸ªURL
        for url in url_list:
            if validators.url(url):
                valid_urls.append(url)
            else:
                print(f"æ— æ•ˆURL: {url}")
                invalid_found = True

        # å…¨éƒ¨æœ‰æ•ˆåˆ™è¿”å›
        if not invalid_found:
            return valid_urls

        # éƒ¨åˆ†æ— æ•ˆæ—¶æä¾›é€‰é¡¹
        choice = input("éƒ¨åˆ†URLæ— æ•ˆï¼Œæ˜¯å¦é‡æ–°è¾“å…¥ï¼Ÿ(yé‡æ–°è¾“å…¥/né€€å‡º): ").strip().lower()
        if choice == 'n':
            print("å·²é€€å‡ºURLè¾“å…¥")
            return None


TARGET_URLS = get_valid_urls()

if TARGET_URLS:
    print(f"æœ‰æ•ˆçš„ç›®æ ‡URLåˆ—è¡¨: {TARGET_URLS}")
    # è¿™é‡Œç»§ç»­ä½ çš„æµ‹è¯•ç¨‹åº
else:
    print("æœªæä¾›æœ‰æ•ˆURLï¼Œç¨‹åºç»ˆæ­¢")
    exit()
# éšæœºåŒ–User-Agentè¯·æ±‚å¤´
USER_AGENTS = [
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36 OPR/26.0.1656.60",
    "Opera/8.0 (Windows NT 5.1; U; en)",
    "Mozilla/5.0 (Windows NT 5.1; U; en; rv:1.8.1) Gecko/20061208 Firefox/2.0.0 Opera 9.50",
    "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; en) Opera 9.50",
    "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:34.0) Gecko/20100101 Firefox/34.0",
    "Mozilla/5.0 (X11; U; Linux x86_64; zh-CN; rv:1.9.2.10) Gecko/20100922 Ubuntu/10.10 (maverick) Firefox/3.6.10",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/534.57.2 (KHTML, like Gecko) Version/5.1.7 Safari/534.57.2",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.71 Safari/537.36",
    "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.64 Safari/537.11",
    "Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.16 (KHTML, like Gecko) Chrome/10.0.648.133 Safari/534.16",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.101 Safari/537.36",
    "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.11 TaoBrowser/2.0 Safari/536.11",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.71 Safari/537.1 LBBROWSER",
    "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; LBBROWSER)",
    "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)",
    "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)",
    "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)",
    "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.84 Safari/535.11 SE 2.X MetaSr 1.0",
    "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; SV1; QQDownload 732; .NET4.0C; .NET4.0E; SE 2.X MetaSr 1.0)",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Maxthon/4.4.3.4000 Chrome/30.0.1599.101 Safari/537.36",
    "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.122 UBrowser/4.0.3214.0 Safari/537.36",
    "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.100 Safari/537.36",
    "Mozilla/5.0 (iPhone; CPU iPhone OS 13_3_1 like Mac OS X; zh-CN) AppleWebKit/537.51.1 (KHTML, like Gecko) Mobile/17D50 UCBrowser/12.8.2.1268 Mobile AliApp(TUnionSDK/0.1.20.3)"
]

# è·å–ç”¨æˆ·è¾“å…¥
try:
    TEST_DURATION = int(input("è¯·è¾“å…¥æµ‹è¯•æ—¶é—´(ä¸€å°æ—¶3600ç§’ï¼ŒåŠå¤©21600ç§’ï¼Œä¸€å¤©43200ç§’)ï¼š"))
    NUM_THREADS = int(input("è¯·è¾“å…¥å¹¶å‘çº¿ç¨‹æ•°ï¼ˆå»ºè®®50-200ï¼‰ï¼š"))
    TASK_CHUNK_SIZE = int(input("è¯·è¾“å…¥ä»»åŠ¡å—å¤§å°ï¼ˆå»ºè®®100-500ï¼‰ï¼š"))
    PROGRESS_INTERVAL = float(input("è¯·è¾“å…¥è¿›åº¦æŠ¥å‘Šé—´éš”(å»ºè®®0.5-2ç§’)ï¼š"))
except ValueError:
    print("é”™è¯¯ï¼šè¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ï¼")
    exit(1)

# éªŒè¯è¾“å…¥æœ‰æ•ˆæ€§
if NUM_THREADS <= 0 or TASK_CHUNK_SIZE <= 0 or TEST_DURATION <= 0 or PROGRESS_INTERVAL <= 0:
    print("é”™è¯¯ï¼šæ‰€æœ‰å‚æ•°å¿…é¡»å¤§äº0ï¼")
    exit(1)

# å…¨å±€çŠ¶æ€
completed = threading.Event()
total_requests = 0
total_success = 0
total_errors = 0
start_time = time.perf_counter()
statistics_lock = threading.Lock()


def create_session():
    """åˆ›å»ºé«˜æ•ˆå¤ç”¨çš„HTTPä¼šè¯ï¼Œæ·»åŠ é‡è¯•ç­–ç•¥å’Œè‡ªå®šä¹‰è¶…æ—¶"""
    session = requests.Session()
    adapter = HTTPAdapter(
        pool_connections=50,
        pool_maxsize=200,
        pool_block=False,
        max_retries=3  # æ·»åŠ æœ‰é™é‡è¯•
    )
    session.mount('https://', adapter)
    session.mount('http://', adapter)

    # è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
    session.timeout = (3.05, 9)  # è¿æ¥3.05ç§’ï¼Œè¯»å–9ç§’

    return session


def send_request(session, url):
    """å‘é€å•ä¸ªHTTPè¯·æ±‚"""
    global total_requests, total_success, total_errors

    headers = {
        "User-Agent": random.choice(USER_AGENTS),
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
        "Connection": "keep-alive"
    }

    try:
        response = session.get(url, headers=headers, verify=False, stream=False)
        response.close()  # ç«‹å³å…³é—­è¿æ¥é‡Šæ”¾èµ„æº
        with statistics_lock:
            total_success += 1
        return True
    except Exception as e:
        with statistics_lock:
            total_errors += 1
        return False
    finally:
        with statistics_lock:
            total_requests += 1


def worker(thread_id):
    """é«˜æ•ˆçº¿ç¨‹å·¥ä½œå‡½æ•°"""
    session = create_session()
    url = TARGET_URLS[thread_id % len(TARGET_URLS)]

    while not completed.is_set():
        # ä½¿ç”¨æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œé¿å…å¤§å—ä»»åŠ¡å¯¼è‡´å»¶è¿Ÿ
        for _ in range(min(50, TASK_CHUNK_SIZE)):
            if completed.is_set():
                break
            send_request(session, url)

    session.close()  # ç¡®ä¿å…³é—­ä¼šè¯é‡Šæ”¾èµ„æº

def monitor_progress():
    """å®æ—¶ç›‘æ§æµ‹è¯•è¿›åº¦ï¼Œæ·»åŠ åŠ¨æ€RPSè®¡ç®—"""
    last_count = 0
    last_time = start_time

    while not completed.is_set():
        time.sleep(PROGRESS_INTERVAL)

        with statistics_lock:
            current_count = total_requests
            success_rate = (total_success / total_requests * 100) if total_requests > 0 else 0

        current_time = time.perf_counter()
        elapsed = current_time - start_time

        # è®¡ç®—å®æ—¶RPSï¼ˆæœ€è¿‘æ—¶é—´æ®µçš„ï¼‰
        time_diff = current_time - last_time
        rps = (current_count - last_count) / time_diff if time_diff > 0 else 0

        last_count = current_count
        last_time = current_time

        # è®¡ç®—å‰©ä½™æ—¶é—´
        remaining = TEST_DURATION - elapsed
        if remaining < 0:
            remaining = 0

        print(f"\râ±ï¸ å·²è¿è¡Œ: {elapsed:.1f}s | å‰©ä½™: {remaining:.1f}s | ğŸ“¤ æ€»è¯·æ±‚: {total_requests} "
              f"| âœ… æˆåŠŸ: {total_success} | âŒ é”™è¯¯: {total_errors} | æˆåŠŸç‡ï¼š({success_rate:.1f}%) "
              f"| âš¡ å®æ—¶RPS: {rps:.1f}", end="")


def main():
    """ä¸»ç¨‹åºå…¥å£"""
    global start_time

    for URLS in TARGET_URLS:
        print(f"ğŸš€ å¼€å§‹å‹åŠ›æµ‹è¯•: ç›®æ ‡URL", URLS)
    print(f"â±ï¸ æŒç»­æ—¶é—´: {TEST_DURATION}ç§’ | ğŸ§µ çº¿ç¨‹æ•°: {NUM_THREADS} | ğŸ“¦ ä»»åŠ¡å—: {TASK_CHUNK_SIZE}")
    start_time = time.perf_counter()

    # å¯åŠ¨ç›‘æ§çº¿ç¨‹
    threading.Thread(target=monitor_progress, daemon=True).start()

    try:
        with ThreadPoolExecutor(max_workers=NUM_THREADS) as executor:
            # æäº¤æ‰€æœ‰å·¥ä½œçº¿ç¨‹
            futures = [executor.submit(worker, i) for i in range(NUM_THREADS)]

            # ç­‰å¾…æµ‹è¯•æ—¶é—´ç»“æŸ
            time.sleep(TEST_DURATION)
            completed.set()

            # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
            for future in futures:
                future.result(timeout=10)  # è®¾ç½®è¶…æ—¶é˜²æ­¢å¡ä½
    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­æµ‹è¯•!")
        completed.set()
    except Exception as e:
        print(f"\n\nâŒ å‘ç”Ÿé”™è¯¯: {str(e)}")
        completed.set()

    # è®¡ç®—æœ€ç»ˆç»“æœ
    total_time = time.perf_counter() - start_time
    rps = total_requests / total_time if total_time > 0 else 0
    success_rate = (total_success / total_requests * 100) if total_requests > 0 else 0

    print(f"\n\nâœ… æµ‹è¯•å®Œæˆ!")
    print(f"â±ï¸ æ€»æ—¶é•¿: {total_time:.2f}ç§’")
    print(f"ğŸ“Š æ€»è¯·æ±‚æ•°: {total_requests} | âœ… æˆåŠŸ: {total_success} | âŒ é”™è¯¯: {total_errors} | æˆåŠŸç‡ï¼š({success_rate:.1f}%)")
    print(f"âš¡ å¹³å‡RPS: {rps:.2f}æ¬¡/ç§’")
    print(f"ğŸ§µ å¹¶å‘çº¿ç¨‹: {NUM_THREADS}")
    print(f"ğŸ” å¹³å‡å»¶è¿Ÿ: {(total_time * 1000 / total_requests) if total_requests > 0 else 0:.2f}ms")

    # å¸¦å®½ä¼°ç®— (å‡è®¾å¹³å‡å“åº”å¤§å°50KB)
    bandwidth = (total_success * 50 * 1024 * 8) / (total_time * 1000000)  # Mbps
    print(f"ğŸŒ ä¼°è®¡å¸¦å®½ä½¿ç”¨: {bandwidth:.2f} Mbps")


if __name__ == "__main__":
    # ç¦ç”¨SSLéªŒè¯è­¦å‘Š
    warnings.filterwarnings("ignore", category=requests.packages.urllib3.exceptions.InsecureRequestWarning)
    main()
